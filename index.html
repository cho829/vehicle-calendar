<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è»Šä¸¡äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³çœç•¥ï¼šå…ˆã»ã©ã®CSSã§OK */
  </style>
</head>
<body>

  <h2>ğŸš— è»Šä¸¡ã‚’è¿½åŠ </h2>
  <form id="vehicle-form">
    <input type="hidden" id="vehicle-edit-index" value="">
    <label>è»Šä¸¡å:</label>
    <input type="text" id="vehicle-name" required><br />
    <label>ãƒŠãƒ³ãƒãƒ¼:</label>
    <input type="text" id="vehicle-plate" required><br />
    <button type="submit">è»Šä¸¡ã‚’è¿½åŠ </button>
  </form>

  <h2>ğŸ“… äºˆç´„ã‚’è¿½åŠ  / ç·¨é›†</h2>
  <form id="reservation-form">
    <input type="hidden" id="edit-index" value="">
    <label>è»Šä¸¡:</label>
    <select id="vehicle-select"></select><br />
    <label>äºˆç´„è€…å:</label>
    <input type="text" id="reserver-name" required /><br />
    <label>é–‹å§‹æ—¥:</label>
    <input type="date" id="start-date" required><br />
    <label>çµ‚äº†æ—¥:</label>
    <input type="date" id="end-date" required><br />
    <label>è²¸å‡ºæ™‚é–“:</label>
    <input type="time" id="start-time" required><br />
    <label>è¿”å´æ™‚é–“:</label>
    <input type="time" id="end-time" required><br />
    <button type="submit">äºˆç´„ã‚’è¿½åŠ  / æ›´æ–°</button>
  </form>

  <h2>ğŸ“Š è»Šä¸¡äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
  <div class="month-controls">
    <button onclick="changeMonth(-1)">â† å‰æœˆ</button>
    <span id="month-label"></span>
    <button onclick="changeMonth(1)">ç¿Œæœˆ â†’</button>
  </div>

  <div class="calendar-container">
    <table>
      <thead>
        <tr>
          <th>è»Šä¸¡å / è»Šç•ª</th>
        </tr>
        <tr id="calendar-header"><th></th></tr>
      </thead>
      <tbody id="calendar-body"></tbody>
    </table>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyCaI_ohlnOsCmJNZAnlI3fu_v4qwu3ISE8",
      authDomain: "vehicle-reservation-1d102.firebaseapp.com",
      projectId: "vehicle-reservation-1d102",
      storageBucket: "vehicle-reservation-1d102.appspot.com",
      messagingSenderId: "461824545561",
      appId: "1:461824545561:web:3541f5b4d08e1fa14e6b88"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    const vehicles = [];
    const reservations = [];
    const vehicleSelect = document.getElementById("vehicle-select");
    const calendarBody = document.getElementById("calendar-body");
    const calendarHeader = document.getElementById("calendar-header");
    const monthLabel = document.getElementById("month-label");
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    // æ—¥ä»˜é…åˆ—å–å¾—
    function getDateArray(year, month) {
      const days = [];
      const date = new Date(year, month, 1);
      while (date.getMonth() === month) {
        days.push(new Date(date));
        date.setDate(date.getDate() + 1);
      }
      return days;
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
    function renderCalendar() {
      const dates = getDateArray(currentYear, currentMonth);
      calendarHeader.innerHTML = "<th></th>";
      dates.forEach(d => {
        const th = document.createElement("th");
        th.textContent = `${d.getMonth() + 1}/${d.getDate()} (${["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][d.getDay()]})`;
        calendarHeader.appendChild(th);
      });

      calendarBody.innerHTML = "";
      vehicles.forEach(vehicle => {
        const filtered = reservations.filter(r => r.plate === vehicle.plate);
        const row = document.createElement("tr");
        const td = document.createElement("td");
        td.textContent = `${vehicle.name} / ${vehicle.plate}`;
        row.appendChild(td);

        dates.forEach(day => {
          const cell = document.createElement("td");
          const matched = filtered.find(r => {
            const start = new Date(`${r.start}T${r.startTime}`);
            const end = new Date(`${r.end}T${r.endTime}`);
            return day >= start && day <= end;
          });
          if (matched) {
            cell.innerHTML = `${matched.name}<br>${matched.startTime}ã€œ${matched.endTime}`;
            cell.style.background = "#f39c12";
            cell.style.color = "#fff";
          }
          row.appendChild(cell);
        });
        calendarBody.appendChild(row);
      });

      monthLabel.textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;
    }

    // æœˆç§»å‹•
    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      } else if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    }

    // è»Šä¸¡ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
    function updateVehicleSelect() {
      vehicleSelect.innerHTML = "";
      vehicles.forEach(vehicle => {
        const opt = document.createElement("option");
        opt.value = vehicle.plate;
        opt.textContent = `${vehicle.name} / ${vehicle.plate}`;
        vehicleSelect.appendChild(opt);
      });
    }

    // Firestoreã‹ã‚‰äºˆç´„å–å¾—
    async function loadReservations() {
      const snapshot = await db.collection("reservations").get();
      reservations.length = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        data._id = doc.id;
        reservations.push(data);
      });
      renderCalendar();
    }

    // åˆæœŸè¡¨ç¤º
    window.addEventListener("DOMContentLoaded", async () => {
      // ä»®ï¼šåˆæœŸè»Šä¸¡ã‚’è¨­å®š
      vehicles.push(
        { name: "ãƒŸãƒ‹ãƒãƒ³ãƒ»ãƒ©ãƒ•ã‚§ã‚¹ã‚¿", plate: "æ²–ç¸„528ã‚6514" },
        { name: "ãƒŸãƒ‹ãƒãƒ³ãƒ»ãƒ“ã‚¢ãƒ³ãƒ†", plate: "æ²–ç¸„328ã‚766" },
        { name: "ãƒŸãƒ‹ãƒãƒ³ãƒ»ã‚»ãƒ¬ãƒŠ", plate: "æ²–ç¸„527ã‚6833" }
      );
      updateVehicleSelect();
      await loadReservations();
    });

    // äºˆç´„è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†
    document.getElementById("reservation-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const index = document.getElementById("edit-index").value;
      const newReservation = {
        plate: vehicleSelect.value,
        name: document.getElementById("reserver-name").value,
        start: document.getElementById("start-date").value,
        end: document.getElementById("end-date").value,
        startTime: document.getElementById("start-time").value,
        endTime: document.getElementById("end-time").value
      };

      if (index === "") {
        const doc = await db.collection("reservations").add(newReservation);
        newReservation._id = doc.id;
      } else {
        newReservation._id = reservations[index]._id;
        await db.collection("reservations").doc(newReservation._id).set(newReservation);
      }

      document.getElementById("reservation-form").reset();
      document.getElementById("edit-index").value = "";
      await loadReservations();
    });

    // è»Šä¸¡è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†
    document.getElementById("vehicle-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("vehicle-name").value;
      const plate = document.getElementById("vehicle-plate").value;
      vehicles.push({ name, plate });
      updateVehicleSelect();
      renderCalendar();
      document.getElementById("vehicle-form").reset();
    });
  </script>
</body>
</html>
