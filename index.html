
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è»Šä¸¡äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>
    table { width: 100%; border-collapse: collapse; font-size: 2px; } /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
    th, td { border: 1px solid #aaa; padding: 4px; text-align: center; }
    th { background: #eee; }
    td.reserved {
  background: #f39c12;
  color: white;
  font-size: 12px;
  font-weight: bold;
}
  td { padding: 8px 5px; } /* ä½™ç™½ã‚’èª¿æ•´ */
  </style>
</head>
<body>
  <h2>ğŸš— è»Šä¸¡ã‚’è¿½åŠ </h2>
  <form id="vehicle-form">
    <label>è»Šä¸¡å:</label><input type="text" id="vehicle-name" required>
    <label>ãƒŠãƒ³ãƒãƒ¼:</label><input type="text" id="vehicle-plate" required>
    <button type="submit">è¿½åŠ </button>
  </form>

  <h2>ğŸ“… äºˆç´„ã‚’è¿½åŠ </h2>
  <form id="reservation-form">
    <label>è»Šä¸¡:</label>
    <select id="vehicle-select"></select>
    <label>äºˆç´„è€…å:</label><input type="text" id="reserver-name" required>
    <label>é–‹å§‹æ—¥:</label><input type="date" id="start-date" required>
    <label>çµ‚äº†æ—¥:</label><input type="date" id="end-date" required>
    <label>è²¸å‡ºæ™‚é–“:</label><input type="time" id="start-time" required>
    <label>è¿”å´æ™‚é–“:</label><input type="time" id="end-time" required>
    <button type="submit">äºˆç´„</button>
  </form>

  <h2>ğŸ“Š ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
  <div>
    <button onclick="changeMonth(-1)">â† å‰æœˆ</button>
    <span id="month-label"></span>
    <button onclick="changeMonth(1)">ç¿Œæœˆ â†’</button>
  </div>
  <table>
    <thead><tr id="calendar-header"><th>è»Šä¸¡å/ãƒŠãƒ³ãƒãƒ¼</th></tr></thead>
    <tbody id="calendar-body"></tbody>
  </table>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCaI_ohlnOsCmJNZAnlI3fu_v4qwu3ISE8",
      authDomain: "vehicle-reservation-1d102.firebaseapp.com",
      projectId: "vehicle-reservation-1d102",
      storageBucket: "vehicle-reservation-1d102.appspot.com",
      messagingSenderId: "461824545561",
      appId: "1:461824545561:web:3541f5b4d08e1fa14e6b88"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const vehicles = [];
    const reservations = [];

    const vehicleSelect = document.getElementById("vehicle-select");
    const calendarHeader = document.getElementById("calendar-header");
    const calendarBody = document.getElementById("calendar-body");
    const monthLabel = document.getElementById("month-label");

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    // ğŸ“… æ—¥ä»˜é…åˆ—ã‚’å–å¾—
    function getDateArray(year, month) {
      const result = [];
      const date = new Date(year, month, 1);
      while (date.getMonth() === month) {
        result.push(new Date(date));
        date.setDate(date.getDate() + 1);
      }
      return result;
    }

    // ğŸ“Š ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
    function renderCalendar() {
      const dates = getDateArray(currentYear, currentMonth);
      calendarHeader.innerHTML = "<th>è»Šä¸¡å / ãƒŠãƒ³ãƒãƒ¼</th>";
      dates.forEach(d => {
        const th = document.createElement("th");
        th.textContent = `${d.getMonth() + 1}/${d.getDate()} (${["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][d.getDay()]})`;
        calendarHeader.appendChild(th);
      });

      calendarBody.innerHTML = "";
      vehicles.forEach(vehicle => {
  const row = document.createElement("tr");
  const td = document.createElement("td");
  td.textContent = `${vehicle.name} / ${vehicle.plate}`;
  row.appendChild(td);

  let i = 0;
  while (i < dates.length) {
    const day = dates[i];

    // ã“ã®æ—¥ã‹ã‚‰å§‹ã¾ã‚‹äºˆç´„ãŒã‚ã‚‹ã‹æ¢ã™
    const reservation = reservations.find(r => {
      if (r.plate !== vehicle.plate) return false;
      const start = new Date(`${r.start}T${r.startTime}`);
      return new Date(start.toDateString()).getTime() === day.getTime();
    });

    if (reservation) {
      const start = new Date(`${reservation.start}T${reservation.startTime}`);
      const end = new Date(`${reservation.end}T${reservation.endTime}`);

      // æœŸé–“ä¸­ã®ä½•æ—¥åˆ†ã‹æ•°ãˆã‚‹
      const span = dates.filter(d => d >= new Date(start.toDateString()) && d <= new Date(end.toDateString())).length;

      const cell = document.createElement("td");
      cell.className = "reserved";
      cell.colSpan = span;
      cell.innerHTML = `${reservation.name}<br>${reservation.startTime}ã€œ${reservation.endTime}`;
      row.appendChild(cell);

      i += span; // spanåˆ†ã‚¹ã‚­ãƒƒãƒ—
    } else {
      const empty = document.createElement("td");
      row.appendChild(empty);
      i++;
    }
  }

  calendarBody.appendChild(row);
});

      monthLabel.textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ`;
    }

    // ğŸ”„ æœˆã‚’å¤‰æ›´
    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      renderCalendar();
    }

    // ğŸ”„ ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°
    function updateVehicleSelect() {
      vehicleSelect.innerHTML = "";
      vehicles.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.plate;
        opt.textContent = `${v.name} / ${v.plate}`;
        vehicleSelect.appendChild(opt);
      });
    }

    // ğŸš— è»Šä¸¡ãƒ•ã‚©ãƒ¼ãƒ 
    document.getElementById("vehicle-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("vehicle-name").value;
      const plate = document.getElementById("vehicle-plate").value;
      await db.collection("vehicles").add({ name, plate });
      e.target.reset();
    });

    // ğŸ“… äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ 
    document.getElementById("reservation-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        plate: vehicleSelect.value,
        name: document.getElementById("reserver-name").value,
        start: document.getElementById("start-date").value,
        end: document.getElementById("end-date").value,
        startTime: document.getElementById("start-time").value,
        endTime: document.getElementById("end-time").value
      };
      await db.collection("reservations").add(data);
      e.target.reset();
    });

    // ğŸ”„ Firestore ã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—
    db.collection("vehicles").onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change => {
    const data = { id: change.doc.id, ...change.doc.data() };
    if (change.type === "added") {
      vehicles.push(data);
    } else if (change.type === "modified") {
      const index = vehicles.findIndex(v => v.id === data.id);
      if (index > -1) vehicles[index] = data;
    } else if (change.type === "removed") {
      const index = vehicles.findIndex(v => v.id === data.id);
      if (index > -1) vehicles.splice(index, 1);
    }
  });
  updateVehicleSelect();
  renderCalendar();
});

db.collection("reservations").onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change => {
    const data = { id: change.doc.id, ...change.doc.data() };
    if (change.type === "added") {
      reservations.push(data);
    } else if (change.type === "modified") {
      const index = reservations.findIndex(r => r.id === data.id);
      if (index > -1) reservations[index] = data;
    } else if (change.type === "removed") {
      const index = reservations.findIndex(r => r.id === data.id);
      if (index > -1) reservations.splice(index, 1);
    }
  });
  renderCalendar();
});


    // åˆæœŸæç”»
    window.addEventListener("DOMContentLoaded", () => renderCalendar());
  </script>
</body>
</html>
